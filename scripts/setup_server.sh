#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ€Ð²ÐµÑ€Ð° ducksnet
set -e

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° ducksnet..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° root Ð¿Ñ€Ð°Ð²Ð°
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ root Ð¿Ñ€Ð°Ð²Ð°. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ sudo"
    exit 1
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt update && apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
apt install -y \
    curl \
    wget \
    git \
    unzip \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker
echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
if ! command -v docker &> /dev/null; then
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    apt update
    apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose
echo "ðŸ“‹ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose..."
if ! command -v docker-compose &> /dev/null; then
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ducksnet..."
if ! id "ducksnet" &>/dev/null; then
    useradd -m -s /bin/bash ducksnet
    usermod -aG docker ducksnet
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
mkdir -p /opt/ducksnet
chown ducksnet:ducksnet /opt/ducksnet

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
cat > /opt/ducksnet/.env << 'EOF'
# Bot Configuration
BOT_TOKEN=your_bot_token_here
BOT_DOMAIN=your-domain.com

# Database
DATABASE_URL=sqlite:///app/db/database.db

# Redis
REDIS_PASSWORD=your_redis_password_here

# Let's Encrypt
LETSENCRYPT_EMAIL=your-email@example.com

# Traefik Dashboard Auth (username:password)
TRAEFIK_AUTH=admin:your_password_hash_here

# VPN Configuration
XUI_PANEL_URL=https://your-xui-panel.com
XUI_USERNAME=your_username
XUI_PASSWORD=your_password

# Payment Gateways
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
CRYPTOMUS_MERCHANT_ID=your_merchant_id
CRYPTOMUS_PAYMENT_KEY=your_payment_key
EOF

chown ducksnet:ducksnet /opt/ducksnet/.env
chmod 600 /opt/ducpsnet/.env

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ° Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
cat > /etc/systemd/system/ducksnet.service << 'EOF'
[Unit]
Description=ducksnet Bot
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/ducksnet
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
TimeoutStartSec=0
User=ducksnet
Group=ducksnet

[Install]
WantedBy=multi-user.target
EOF

# Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
systemctl daemon-reload
systemctl enable ducksnet.service

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall
echo "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall..."
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ..."
cat > /opt/ducksnet/update.sh << 'EOF'
#!/bin/bash
cd /opt/ducksnet
git pull origin main
docker-compose down
docker-compose up -d --build
docker system prune -f
EOF

chmod +x /opt/ducksnet/update.sh
chown ducksnet:ducksnet /opt/ducksnet/update.sh

echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ /opt/ducksnet/.env Ñ„Ð°Ð¹Ð» Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸"
echo "2. Ð¡ÐºÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ð°Ñˆ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð² /opt/ducksnet"
echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: sudo systemctl start ducksnet"
echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ: sudo systemctl status ducksnet"
echo ""
echo "ðŸ” Ð”Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ…ÐµÑˆÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ Traefik Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:"
echo "echo -n 'admin:password' | base64"
echo ""
echo "ðŸŒ Traefik Dashboard Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: https://traefik.your-domain.com"
